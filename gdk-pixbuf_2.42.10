#!/bin/bash
availables=(introspection png jpeg tiff)
available_options=(gio_sniffing man tests installed_tests gtk_doc docs relocatable native_windows_loaders)

# all, none, windows, png, bmp, gif, ico, ani, jpeg, pnm, tiff, xpm, xbm, tga, icns, qtif
builtin_loaders=()
options=()
enables=()
activates=(relocatable)
if [[ "$OSTYPE" == "msys"* || "$OSTYPE" == "mingw"* || $OSTYPE == "cygwin"* ]]; then
    activates+=(native_windows_loaders)
    builtin_loaders=(windows)
elif [[ "$OSTYPE" == "linux"* || "$OSTYPE" == "freebsd"* ]]; then
    builtin_loaders=(xpm)
fi

while [ ! -z ${1+x} ]; do
    case $1 in
    # -introspection)
    #     # currently broken, missing command g-ir-scanner
    #     enables+=(introspection)
    #     dependency glib
    #     ;;
    -png)
        if [[ ! " ${builtin_loaders[*]} " == *" windows "* ]]; then
            builtin_loaders+=(png)
        fi
        enables+=(png)
        dependency libpng16
        ;;
    -jpeg)
        if [[ ! " ${builtin_loaders[*]} " == *" windows "* ]]; then
            builtin_loaders+=(jpeg)
        fi
        enables+=(jpeg)
        # It seems that at least on linux the -pic option is needed for jpeg even when
        # building static libraries.
        dependency libjpeg -pic
        ;;
    -tiff)
        if [[ ! " ${builtin_loaders[*]} " == *" windows "* ]]; then
            builtin_loaders+=(tiff)
        fi
        enables+=(tiff)
        # Currently there is no lhelper recipe for libtiff
        dependency libtiff-4
        ;;
    *)
        options+=("$1")
        ;;
    esac
    shift
done

IFS=','
options+=(-Dbuiltin_loaders="${builtin_loaders[*]}")
IFS=$' \t\n'

for opt in "${availables[@]}"; do
    if [[ " ${enables[*]} " == *" $opt "* ]]; then
        options+=(-D$opt=enabled)
    else
        options+=(-D$opt=disabled)
    fi
done

for opt in "${available_options[@]}"; do
    if [[ " ${activates[*]} " == *" $opt "* ]]; then
        options+=(-D$opt=true)
    else
        options+=(-D$opt=false)
    fi
done

enter_git_repository "https://gitlab.gnome.org/GNOME/gdk-pixbuf.git" "$version"
build_and_install meson "${options[@]}"


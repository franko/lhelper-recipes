dependency lua
enter_archive "https://github.com/hoelzro/lua-linenoise/archive/${version}.tar.gz"

cat << EOF > meson.build
project('lua-linenoise', 'c')

lua_puc_rio_dep = dependency('lua', required : false)
if lua_puc_rio_dep.found()
    lua_dep = lua_puc_rio_dep
    lua_abiver = lua_dep.version().substring(0, 3)
else
    lua_dep = dependency('luajit')
    if lua_dep.version().substring(0, 3) in ['2.0', '2.1']
        lua_abiver = '5.1'
    else
        error('unknown luajit version: ' + lua_dep.version())
    endif
endif

ln_deps = [ lua_dep ]

ln_sources = ['linenoise.c', 'linenoiselib.c', 'encodings/utf8.c']
if host_machine.system() == 'windows'
    ln_sources += 'win32fixes.c'
    ln_deps += meson.get_compiler('c').find_library('ws2_32', required: true)
endif

shared_library('linenoise', ln_sources,
    dependencies : ln_deps,
    name_prefix : '',
    install_dir : 'lib/lua/' + lua_abiver,
    install : true,
)
EOF

build_and_install meson "$@"
